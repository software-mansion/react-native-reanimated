---
id: bundleMode
title: Bundle Mode
sidebar_label: Bundle Mode
---

# Bundle Mode

Bundle Mode is a feature that gives worklets access to your whole JavaScript bundle - meaning that any code that's present in the bundle can be executed in any worklet and on any runtime. This means that third party libraries can be used in worklets without the need to patch them.

## Setup

Install `react-native-worklets` package with the `bundle-mode-preview` tag:

```sh
yarn add react-native-worklets@bundle-mode-preview
```

or

```sh
npm i react-native-worklets@bundle-mode-preview
```

### General

To use `react-native-worklets`'s Bundle Mode feature, you need to make the following changes in your repository:

1. **Modify your Babel configuration**. [Worklets Babel Plugin](/docs/worklets-babel-plugin/about) needs to know that it has to prepare your code for the Bundle Mode. In your `babel.config.js` file, add the following:

   ```javascript
   /** @type {import('react-native-worklets/plugin').PluginOptions} */
   // highlight-next-line
   const workletsPluginOptions = {
     // highlight-next-line
     bundleMode: true,
     // highlight-next-line
   }

   module.exports = {
     presets: [
       ... // don't add it here :)
     ],
     plugins: [
       ...
       // highlight-next-line
       ['react-native-worklets/plugin', workletsPluginOptions],
     ],
   };
   ```

2. **Modify your Metro configuration**. Metro needs to be configured pre-load Bundle Mode entry points into your JavaScript bundle. In your `metro.config.js` file, apply the config required for the bundle mode. For example:

   ```javascript
   const {
     getDefaultConfig,
     mergeConfig,
   } = require('@react-native/metro-config');
   // highlight-next-line
   const {
     // highlight-next-line
     bundleModeMetroConfig,
     // highlight-next-line
   } = require('react-native-worklets/bundleMode');

   const config = {
     // Your config
   };

   module.exports = mergeConfig(
     getDefaultConfig(__dirname),
     // highlight-next-line
     bundleModeMetroConfig,
     config
   );
   ```

### iOS

1. **Reinstall your Pods**. You install your pods with an environment variable `WORKLETS_BUNDLE_MODE` set to `"1"` to enable the Bundle Mode.

   ```sh
    WORKLETS_BUNDLE_MODE=1 bundle exec pod install
   ```

2. Alternatively, you modify your Podfile to always set this variable when installing pods:

   ```ruby
   # top level
   ENV['WORKLETS_BUNDLE_MODE'] = '1'
   ```

### Android

1. **Modify your `gradle.properties`**. You must set a build property `workletsBundleMode` to enable Bundle Mode. In your `android/gradle.properties`, add the following:

   ```groovy
   workletsBundleMode=true
   ```

### Enable seamless Metro bundling

_This step is optional but highly recommended._

If you run the app after just executing the above steps, you will see an error "Failed to get the SHA-1 for ...":

import useBaseUrl from '@docusaurus/useBaseUrl';
import ThemedImage from '@theme/ThemedImage';

<ThemedImage
  sources={{
    light: useBaseUrl('/img/sha-light.png'),
    dark: useBaseUrl('/img/sha-dark.png'),
  }}
  alt="Bundle Mode Metro error logs"
/>

This is due to fact that Bundle Mode isolates each worklet in a separate module (file) on the fly and the Metro bundler doesn't index these isolated modules in time.

To fix this issue you can do one of the following:

1. Reload the app and Metro a couple of times until Metro picks up all the new modules. You will have to do it each time. Not recommended.
2. Patch `metro` package for it to synchronously index new modules created by Bundle Mode. This is the recommended approach. These patches **do not require building React Native from source**. You can find patching instructions in the [Worklets repository](https://github.com/software-mansion/react-native-reanimated/tree/main/packages/react-native-worklets/bundleMode/patches).

This patch is a temporary workaround until necessary changes are merged into Metro.

### Enable fast refresh on Worklet Runtimes

_This step is optional but highly recommended._

React Native's Fast Refresh (hot reload) feature doesn't apply to Worklet Runtimes out of the box. Therefore, when you change worklet's code you will see an error "\[Worklets\] Unable to resolve worklet with hash ...".

<ThemedImage
  sources={{
    light: useBaseUrl('/img/hot-light.png'),
    dark: useBaseUrl('/img/hot-dark.png'),
  }}
  alt="Bundle Mode Fast Refresh error logs"
/>

This is due to fact that the Fast Refresh update wasn't sent to the Worklet Runtime and it doesn't know that new worklet with the given hash exists.

To fix this issue you can do one of two thing:

1. Reload the app on each worklet code change. This virtually defeats the purpose of Fast Refresh. Not recommended.
2. Patch `metro-runtime` package for it to send Fast Refresh updates to Worklet Runtimes. You can find patching instructions in the [Worklets repository](https://github.com/software-mansion/react-native-reanimated/tree/main/packages/react-native-worklets/bundleMode/patches).

This patch is a temporary workaround until necessary changes are merged into Metro.

### Final steps

Make sure to [clear your Metro bundler's cache](/docs/#clear-metro-bundler-cache-recommended) to ensure that all the changes are applied correctly.

And that's it! You can now happily enjoy the Bundle Mode!

## Running third party libraries in Worklets

Third party libraries have to be on an allow-list to use them in worklets. This is because libraries can come with side-effects that would break a Worklet Runtime. For instance, a library that imports something from React Native can't be used on a Worklet Runtime. This would load a second instance of React Native and break your app.

To add a library to the allow-list you only need to set the `workletizableModules` option in Worklets Babel plugin, which is an array of library names. For instance, if you want to use `my-library` on a Worklet Runtime.

```javascript
/** @type {import('react-native-worklets/plugin').PluginOptions} */
const workletsPluginOptions = {
  bundleMode: true,
  // highlight-next-line
  workletizableModules: ['my-library'],
};
```

`workletizableModules` API is temporary and will be replaced with a more robust solution in the future.

## Reference

To see how the setup looks in a real project, you can check out the [Bundle Mode Showcase App](https://github.com/software-mansion-labs/Bundle-Mode-showcase-app) repository.
