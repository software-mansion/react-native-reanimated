'use strict';

import { ReanimatedError } from '../../../../../common';
import { ERROR_MESSAGES, processSVGPath } from '../path';

describe(processSVGPath, () => {
  describe('M command', () => {
    test.each([
      ['M 10 10', [{ M: { x: 10, y: 10 }, C: [], Z: false }]],
      ['m 10 10', [{ M: { x: 10, y: 10 }, C: [], Z: false }]],
      [
        'M 10 10 20 20 30 30',
        [
          {
            M: { x: 10, y: 10 },
            C: [
              [
                { x: 10, y: 10 },
                { x: 13.333333333333334, y: 13.333333333333334 },
                { x: 16.666666666666668, y: 16.666666666666668 },
                { x: 20, y: 20 },
              ],
              [
                { x: 20, y: 20 },
                { x: 23.333333333333332, y: 23.333333333333332 },
                { x: 26.666666666666668, y: 26.666666666666668 },
                { x: 30, y: 30 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 10 10 m 20 20',
        [
          { M: { x: 10, y: 10 }, C: [], Z: false },
          { M: { x: 30, y: 30 }, C: [], Z: false },
        ],
      ],
      [
        'M 10 10 m 20 20 30 30',
        [
          { M: { x: 10, y: 10 }, C: [], Z: false },
          {
            M: { x: 30, y: 30 },
            C: [
              [
                { x: 30, y: 30 },
                { x: 40, y: 40 },
                { x: 50, y: 50 },
                { x: 60, y: 60 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 10 10 0 10 0 0 10 0 10 10',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 3.3333333333333335, y: 3.3333333333333335 },
                { x: 6.666666666666667, y: 6.666666666666667 },
                { x: 10, y: 10 },
              ],
              [
                { x: 10, y: 10 },
                { x: 6.666666666666666, y: 10 },
                { x: 3.333333333333333, y: 10 },
                { x: 0, y: 10 },
              ],
              [
                { x: 0, y: 10 },
                { x: 0, y: 6.666666666666666 },
                { x: 0, y: 3.333333333333333 },
                { x: 0, y: 0 },
              ],
              [
                { x: 0, y: 0 },
                { x: 3.3333333333333335, y: 0 },
                { x: 6.666666666666667, y: 0 },
                { x: 10, y: 0 },
              ],
              [
                { x: 10, y: 0 },
                { x: 10, y: 3.3333333333333335 },
                { x: 10, y: 6.666666666666667 },
                { x: 10, y: 10 },
              ],
            ],
            Z: false,
          },
        ],
      ],
    ])('for %p returns %p', (input, expected) => {
      expect(processSVGPath(input)).toEqual(expected);
    });
  });

  describe('C and S commands (Cubic)', () => {
    test.each([
      [
        'M 0 0 C 10 10 20 20 30 30',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 10, y: 10 },
                { x: 20, y: 20 },
                { x: 30, y: 30 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 10 10 c 10 10 20 20 30 30',
        [
          {
            M: { x: 10, y: 10 },
            C: [
              [
                { x: 10, y: 10 },
                { x: 20, y: 20 },
                { x: 30, y: 30 },
                { x: 40, y: 40 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 C 10 10 20 20 30 30 S 50 50 60 60',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 10, y: 10 },
                { x: 20, y: 20 },
                { x: 30, y: 30 },
              ],
              [
                { x: 30, y: 30 },
                { x: 40, y: 40 },
                { x: 50, y: 50 },
                { x: 60, y: 60 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 C 10 10 20 20 30 30 Z S 40 40 50 50',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 10, y: 10 },
                { x: 20, y: 20 },
                { x: 30, y: 30 },
              ],
            ],
            Z: true,
          },
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 0, y: 0 },
                { x: 40, y: 40 },
                { x: 50, y: 50 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 L 10 10 S 20 20 30 30',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 3.3333333333333335, y: 3.3333333333333335 },
                { x: 6.666666666666667, y: 6.666666666666667 },
                { x: 10, y: 10 },
              ],
              [
                { x: 10, y: 10 },
                { x: 10, y: 10 },
                { x: 20, y: 20 },
                { x: 30, y: 30 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 L 30 30 S 50 50 60 60',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 10, y: 10 },
                { x: 20, y: 20 },
                { x: 30, y: 30 },
              ],
              [
                { x: 30, y: 30 },
                { x: 30, y: 30 },
                { x: 50, y: 50 },
                { x: 60, y: 60 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 Q 10 10 20 20 S 30 30 40 40',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 6.666666666666666, y: 6.666666666666666 },
                { x: 13.333333333333334, y: 13.333333333333334 },
                { x: 20, y: 20 },
              ],
              [
                { x: 20, y: 20 },
                { x: 20, y: 20 },
                { x: 30, y: 30 },
                { x: 40, y: 40 },
              ],
            ],
            Z: false,
          },
        ],
      ],
    ])('for %p returns %p', (input, expected) => {
      expect(processSVGPath(input)).toEqual(expected);
    });
  });

  describe('Q and T commands', () => {
    test.each([
      [
        'M 0 0 Q 15 15 30 0',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 10, y: 10 },
                { x: 20, y: 10 },
                { x: 30, y: 0 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 Q 15 15 30 0 T 60 0',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 10, y: 10 },
                { x: 20, y: 10 },
                { x: 30, y: 0 },
              ],
              [
                { x: 30, y: 0 },
                { x: 40, y: -10 },
                { x: 50, y: -10 },
                { x: 60, y: 0 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 Q 30 30 60 0 Q 90 -30 120 0',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 20, y: 20 },
                { x: 40, y: 20 },
                { x: 60, y: 0 },
              ],
              [
                { x: 60, y: 0 },
                { x: 80, y: -20 },
                { x: 100, y: -20 },
                { x: 120, y: 0 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 L 30 30 T 60 60',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 10, y: 10 },
                { x: 20, y: 20 },
                { x: 30, y: 30 },
              ],
              [
                { x: 30, y: 30 },
                { x: 30, y: 30 },
                { x: 40, y: 40 },
                { x: 60, y: 60 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 q 15 15 30 0 t 30 0',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 10, y: 10 },
                { x: 20, y: 10 },
                { x: 30, y: 0 },
              ],
              [
                { x: 30, y: 0 },
                { x: 40, y: -10 },
                { x: 50, y: -10 },
                { x: 60, y: 0 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 Q 10 10 20 0 T 40 0 T 60 0',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 6.666666666666666, y: 6.666666666666666 },
                { x: 13.333333333333334, y: 6.666666666666666 },
                { x: 20, y: 0 },
              ],
              [
                { x: 20, y: 0 },
                { x: 26.666666666666664, y: -6.666666666666666 },
                { x: 33.333333333333336, y: -6.666666666666666 },
                { x: 40, y: 0 },
              ],
              [
                { x: 40, y: 0 },
                { x: 46.666666666666664, y: 6.666666666666666 },
                { x: 53.333333333333336, y: 6.666666666666666 },
                { x: 60, y: 0 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 C 10 10 20 20 30 30 T 40 40',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 10, y: 10 },
                { x: 20, y: 20 },
                { x: 30, y: 30 },
              ],
              [
                { x: 30, y: 30 },
                { x: 30, y: 30 },
                { x: 33.333333333333336, y: 33.333333333333336 },
                { x: 40, y: 40 },
              ],
            ],
            Z: false,
          },
        ],
      ],
    ])('for %p returns %p', (input, expected) => {
      expect(processSVGPath(input)).toEqual(expected);
    });
  });

  describe('A (Arc) command', () => {
    test.each([
      [
        'M 0 0 A 0 0 0 0 0 30 30',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 10, y: 10 },
                { x: 20, y: 20 },
                { x: 30, y: 30 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 1 0 A 1 1 0 0 1 0 1',
        [
          {
            M: { x: 1, y: 0 },
            C: [
              [
                { x: 1, y: 0 },
                { x: 1, y: 0.5522847498307933 },
                { x: 0.5522847498307935, y: 1 },
                { x: 6.123233995736766e-17, y: 1 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M -1 0 A 1 1 0 0 1 1 0',
        [
          {
            M: { x: -1, y: 0 },
            C: [
              [
                { x: -1, y: 0 },
                { x: -1, y: -0.5522847498307932 },
                { x: -0.5522847498307936, y: -0.9999999999999999 },
                { x: -1.8369701987210297e-16, y: -1 },
              ],
              [
                { x: -1.8369701987210297e-16, y: -1 },
                { x: 0.5522847498307931, y: -1 },
                { x: 0.9999999999999999, y: -0.5522847498307936 },
                { x: 1, y: -2.4492935982947064e-16 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 1 0 A -1 -1 0 0 1 0 1',
        [
          {
            M: { x: 1, y: 0 },
            C: [
              [
                { x: 1, y: 0 },
                { x: 1, y: 0.5522847498307933 },
                { x: 0.5522847498307935, y: 1 },
                { x: 6.123233995736766e-17, y: 1 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 1 0 A 1 1 0 0 0 0 1',
        [
          {
            M: { x: 1, y: 0 },
            C: [
              [
                { x: 1, y: 0 },
                { x: 0.44771525016920677, y: 0 },
                { x: 1.1102230246251565e-16, y: 0.44771525016920655 },
                { x: 0, y: 0.9999999999999999 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 1 0 A 1 1 0 0 2 0 1',
        [
          {
            M: { x: 1, y: 0 },
            C: [
              [
                { x: 1, y: 0 },
                { x: 1, y: 0.5522847498307933 },
                { x: 0.5522847498307935, y: 1 },
                { x: 6.123233995736766e-17, y: 1 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 1 0 A 1 1 720 0 1 0 1',
        [
          {
            M: { x: 1, y: 0 },
            C: [
              [
                { x: 1, y: 0 },
                { x: 1, y: 0.5522847498307933 },
                { x: 0.5522847498307935, y: 1 },
                { x: 6.123233995736766e-17, y: 1 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      ['M 10 10 A 5 5 0 0 1 10 10', [{ M: { x: 10, y: 10 }, C: [], Z: false }]],
      [
        'M -1 0 A 1 1 0 1 1 1 0',
        [
          {
            M: { x: -1, y: 0 },
            C: [
              [
                { x: -1, y: 0 },
                { x: -1, y: -0.5522847498307932 },
                { x: -0.5522847498307936, y: -0.9999999999999999 },
                { x: -1.8369701987210297e-16, y: -1 },
              ],
              [
                { x: -1.8369701987210297e-16, y: -1 },
                { x: 0.5522847498307931, y: -1 },
                { x: 0.9999999999999999, y: -0.5522847498307936 },
                { x: 1, y: -2.4492935982947064e-16 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 A 1 1 0 0 1 4 0',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 0, y: -1.1045694996615865 },
                { x: 0.8954305003384129, y: -1.9999999999999998 },
                { x: 1.9999999999999996, y: -2 },
              ],
              [
                { x: 1.9999999999999996, y: -2 },
                { x: 3.1045694996615865, y: -2 },
                { x: 4, y: -1.1045694996615871 },
                { x: 4, y: -4.898587196589413e-16 },
              ],
            ],
            Z: false,
          },
        ],
      ],
      [
        'M 0 0 A 2 1 90 0 1 2 2',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 0.2761423749153967, y: -1.104569499661586 },
                { x: 0.9477152501692064, y: -1.5522847498307932 },
                { x: 1.4999999999999998, y: -1 },
              ],
              [
                { x: 1.4999999999999998, y: -1 },
                { x: 2.052284749830793, y: -0.4477152501692068 },
                { x: 2.2761423749153966, y: 0.8954305003384129 },
                { x: 2, y: 1.9999999999999996 },
              ],
            ],
            Z: false,
          },
        ],
      ],
    ])('for %p returns %p', (input, expected) => {
      expect(processSVGPath(input)).toEqual(expected);
    });
  });

  describe('Z (Close) command', () => {
    test.each([
      [
        'M 0 0 L 30 30 Z',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 10, y: 10 },
                { x: 20, y: 20 },
                { x: 30, y: 30 },
              ],
            ],
            Z: true,
          },
        ],
      ],
      [
        'M 0 0 L 10 10 Z M 50 50 L 60 60 Z',
        [
          {
            M: { x: 0, y: 0 },
            C: [
              [
                { x: 0, y: 0 },
                { x: 3.3333333333333335, y: 3.3333333333333335 },
                { x: 6.666666666666667, y: 6.666666666666667 },
                { x: 10, y: 10 },
              ],
            ],
            Z: true,
          },
          {
            M: { x: 50, y: 50 },
            C: [
              [
                { x: 50, y: 50 },
                { x: 53.333333333333336, y: 53.333333333333336 },
                { x: 56.666666666666664, y: 56.666666666666664 },
                { x: 60, y: 60 },
              ],
            ],
            Z: true,
          },
        ],
      ],
    ])('for %p returns %p', (input, expected) => {
      expect(processSVGPath(input)).toEqual(expected);
    });
  });

  describe('Number Parsing', () => {
    test.each([
      ['M 1e2 10', [{ M: { x: 100, y: 10 }, C: [], Z: false }]],
      ['M 10 1e-1', [{ M: { x: 10, y: 0.1 }, C: [], Z: false }]],
      ['M .5 .5', [{ M: { x: 0.5, y: 0.5 }, C: [], Z: false }]],
      [
        'M 10 10-10-10',
        [
          {
            M: { x: 10, y: 10 },
            C: [
              [
                { x: 10, y: 10 },
                { x: 3.333333333333333, y: 3.333333333333333 },
                { x: -3.333333333333334, y: -3.333333333333334 },
                { x: -10, y: -10 },
              ],
            ],
            Z: false,
          },
        ],
      ],
    ])('for %p returns %p', (input, expected) => {
      expect(processSVGPath(input)).toEqual(expected);
    });
  });

  describe('Validation Errors', () => {
    test.each([
      ['M 10', ERROR_MESSAGES.invalidSVGPathCommand('M', [10])],
      // If M has more than 2 elements, they are porvided in pairs to implicit L commands (which then turn into C commands)
      ['M 10 10 10', ERROR_MESSAGES.invalidSVGPathCommand('L', [10])],
      // Regexp skips all symbols that aren't proper commands so the first one taken is v
      ['invalid', ERROR_MESSAGES.invalidSVGPathStart('v')],
      ['M 0 0 L 10', ERROR_MESSAGES.invalidSVGPathCommand('L', [10])],
      [
        'M 0 0 C 10 10 20 20',
        ERROR_MESSAGES.invalidSVGPathCommand('C', [10, 10, 20, 20]),
      ],
      [
        'M 0 0 A 10 10 0 0 1',
        ERROR_MESSAGES.invalidSVGPathCommand('A', [10, 10, 0, 0, 1]),
      ],
      ['bdd M 10 10', [{ M: { x: 10, y: 10 }, C: [], Z: false }]],
      ['bad M 10 10', ERROR_MESSAGES.invalidSVGPathStart('a')],
      ['M 10 10 bad', ERROR_MESSAGES.invalidSVGPathCommand('a', [])],
    ])('handles %p', (input, expected) => {
      if (Array.isArray(expected)) {
        expect(processSVGPath(input)).toEqual(expected);
      } else {
        expect(() => processSVGPath(input)).toThrow(
          new ReanimatedError(expected)
        );
      }
    });
  });
});
