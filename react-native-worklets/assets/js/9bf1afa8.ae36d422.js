"use strict";(self.webpackChunkdocs_worklets=self.webpackChunkdocs_worklets||[]).push([[271],{6645:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>B,contentTitle:()=>z,default:()=>W,frontMatter:()=>Y,metadata:()=>s,toc:()=>X});const s=JSON.parse('{"id":"threading/runOnJS","title":"runOnJS","description":"runOnJS lets you asynchronously run non-workletized functions that couldn\'t otherwise run on the UI thread. This applies to most external libraries as they don\'t have their functions marked with \\"worklet\\"; directive.","source":"@site/docs/threading/runOnJS.mdx","sourceDirName":"threading","slug":"/threading/runOnJS","permalink":"/react-native-reanimated/react-native-worklets/docs/threading/runOnJS","draft":false,"unlisted":false,"editUrl":"https://github.com/software-mansion/react-native-reanimated/edit/main/packages/docs-worklets/docs/threading/runOnJS.mdx","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Threading","permalink":"/react-native-reanimated/react-native-worklets/docs/category/threading"},"next":{"title":"runOnUI","permalink":"/react-native-reanimated/react-native-worklets/docs/threading/runOnUI"}}');var i=n(4848),r=n(8453),a=n(6540),o=n(9176),l=n(1691),c=n(1618),u=n(6325),d=n(1804),h="DELAY",m="ERROR",f="LONG_PRESS_DETECTED",p="NOT_RESPONDER",_="RESPONDER_ACTIVE_LONG_PRESS_START",E="RESPONDER_ACTIVE_PRESS_START",g="RESPONDER_INACTIVE_PRESS_START",S="RESPONDER_RELEASE",v="RESPONDER_TERMINATED",R=Object.freeze({NOT_RESPONDER:{DELAY:m,RESPONDER_GRANT:g,RESPONDER_RELEASE:m,RESPONDER_TERMINATED:m,LONG_PRESS_DETECTED:m},RESPONDER_INACTIVE_PRESS_START:{DELAY:E,RESPONDER_GRANT:m,RESPONDER_RELEASE:p,RESPONDER_TERMINATED:p,LONG_PRESS_DETECTED:m},RESPONDER_ACTIVE_PRESS_START:{DELAY:m,RESPONDER_GRANT:m,RESPONDER_RELEASE:p,RESPONDER_TERMINATED:p,LONG_PRESS_DETECTED:_},RESPONDER_ACTIVE_LONG_PRESS_START:{DELAY:m,RESPONDER_GRANT:m,RESPONDER_RELEASE:p,RESPONDER_TERMINATED:p,LONG_PRESS_DETECTED:_},ERROR:{DELAY:p,RESPONDER_GRANT:g,RESPONDER_RELEASE:p,RESPONDER_TERMINATED:p,LONG_PRESS_DETECTED:p}}),P=e=>e===E||e===_,y=e=>"button"===e.getAttribute("role"),T=e=>e===g||e===E||e===_,x=e=>{var t=e.key,n=e.target.getAttribute("role");return"Enter"===t||(" "===t||"Spacebar"===t)&&"button"===n};class D{constructor(e){this._eventHandlers=null,this._isPointerTouch=!1,this._longPressDelayTimeout=null,this._longPressDispatched=!1,this._pressDelayTimeout=null,this._pressOutDelayTimeout=null,this._touchState=p,this.configure(e)}configure(e){this._config=e}reset(){this._cancelLongPressDelayTimeout(),this._cancelPressDelayTimeout(),this._cancelPressOutDelayTimeout()}getEventHandlers(){return null==this._eventHandlers&&(this._eventHandlers=this._createEventHandlers()),this._eventHandlers}_createEventHandlers(){var e=(e,t)=>{e.persist(),this._cancelPressOutDelayTimeout(),this._longPressDispatched=!1,this._selectionTerminated=!1,this._touchState=p,this._isPointerTouch="touchstart"===e.nativeEvent.type,this._receiveSignal("RESPONDER_GRANT",e);var n=b(this._config.delayPressStart,0,50);!1!==t&&n>0?this._pressDelayTimeout=setTimeout((()=>{this._receiveSignal(h,e)}),n):this._receiveSignal(h,e);var s=b(this._config.delayLongPress,10,450);this._longPressDelayTimeout=setTimeout((()=>{this._handleLongPress(e)}),s+n)},t=e=>{this._receiveSignal(S,e)},n=e=>{var s=this._config.onPress,i=e.target;if(this._touchState!==p&&x(e)){t(e),document.removeEventListener("keyup",n);var r=i.getAttribute("role"),a=i.tagName.toLowerCase();null==s||("link"===r||"a"===a||"button"===a||"input"===a||"select"===a||"textarea"===a)||s(e)}};return{onStartShouldSetResponder:e=>{var t=this._config.disabled;return t&&y(e.currentTarget)&&e.stopPropagation(),null==t||!t},onKeyDown:t=>{var s=this._config.disabled,i=t.key,r=t.target;if(!s&&x(t)){this._touchState===p&&(e(t,!1),document.addEventListener("keyup",n));var a=r.getAttribute("role");(" "===i||"Spacebar"===i)&&("button"===a||"menuitem"===a)&&t.preventDefault(),t.stopPropagation()}},onResponderGrant:t=>e(t),onResponderMove:e=>{null!=this._config.onPressMove&&this._config.onPressMove(e);var t=O(e);if(null!=this._touchActivatePosition){var n=this._touchActivatePosition.pageX-t.pageX,s=this._touchActivatePosition.pageY-t.pageY;Math.hypot(n,s)>10&&this._cancelLongPressDelayTimeout()}},onResponderRelease:e=>t(e),onResponderTerminate:e=>{"selectionchange"===e.nativeEvent.type&&(this._selectionTerminated=!0),this._receiveSignal(v,e)},onResponderTerminationRequest:e=>{var t=this._config,n=t.cancelable,s=t.disabled,i=t.onLongPress;return!(!s&&null!=i&&this._isPointerTouch&&"contextmenu"===e.nativeEvent.type)&&(null==n||n)},onClick:e=>{var t=this._config,n=t.disabled,s=t.onPress;n?y(e.currentTarget)&&e.stopPropagation():(e.stopPropagation(),this._longPressDispatched||this._selectionTerminated?e.preventDefault():null!=s&&!1===e.altKey&&s(e))},onContextMenu:e=>{var t=this._config,n=t.disabled,s=t.onLongPress;n?y(e.currentTarget)&&e.stopPropagation():null!=s&&this._isPointerTouch&&!e.defaultPrevented&&(e.preventDefault(),e.stopPropagation())}}}_receiveSignal(e,t){var n=this._touchState,s=null;null!=R[n]&&(s=R[n][e]),this._touchState===p&&e===S||(null==s||s===m?console.error("PressResponder: Invalid signal "+e+" for state "+n+" on responder"):n!==s&&(this._performTransitionSideEffects(n,s,e,t),this._touchState=s))}_performTransitionSideEffects(e,t,n,s){if((e=>e===v||e===S)(n)&&(setTimeout((()=>{this._isPointerTouch=!1}),0),this._touchActivatePosition=null,this._cancelLongPressDelayTimeout()),T(e)&&n===f){var i=this._config.onLongPress;null!=i&&null==s.nativeEvent.key&&(i(s),this._longPressDispatched=!0)}var r=P(e),a=P(t);if(!r&&a?this._activate(s):r&&!a&&this._deactivate(s),T(e)&&n===S){var o=this._config,l=o.onLongPress;if(null!=o.onPress)null!=l&&e===_||a||r||(this._activate(s),this._deactivate(s))}this._cancelPressDelayTimeout()}_activate(e){var t=this._config,n=t.onPressChange,s=t.onPressStart,i=O(e);this._touchActivatePosition={pageX:i.pageX,pageY:i.pageY},null!=s&&s(e),null!=n&&n(!0)}_deactivate(e){var t=this._config,n=t.onPressChange,s=t.onPressEnd;function i(){null!=s&&s(e),null!=n&&n(!1)}var r=b(this._config.delayPressEnd);r>0?this._pressOutDelayTimeout=setTimeout((()=>{i()}),r):i()}_handleLongPress(e){this._touchState!==E&&this._touchState!==_||this._receiveSignal(f,e)}_cancelLongPressDelayTimeout(){null!=this._longPressDelayTimeout&&(clearTimeout(this._longPressDelayTimeout),this._longPressDelayTimeout=null)}_cancelPressDelayTimeout(){null!=this._pressDelayTimeout&&(clearTimeout(this._pressDelayTimeout),this._pressDelayTimeout=null)}_cancelPressOutDelayTimeout(){null!=this._pressOutDelayTimeout&&(clearTimeout(this._pressOutDelayTimeout),this._pressOutDelayTimeout=null)}}function b(e,t,n){return void 0===t&&(t=0),void 0===n&&(n=0),Math.max(t,null!=e?e:n)}function O(e){var t=e.nativeEvent,n=t.changedTouches,s=t.touches;return null!=s&&s.length>0?s[0]:null!=n&&n.length>0?n[0]:e.nativeEvent}var j=["activeOpacity","delayPressIn","delayPressOut","delayLongPress","disabled","focusable","onLongPress","onPress","onPressIn","onPressOut","rejectResponderTermination","style"];function A(e,t){var n=e.activeOpacity,s=e.delayPressIn,i=e.delayPressOut,r=e.delayLongPress,l=e.disabled,h=e.focusable,m=e.onLongPress,f=e.onPress,p=e.onPressIn,_=e.onPressOut,E=e.rejectResponderTermination,g=e.style,S=(0,u.A)(e,j),v=(0,a.useRef)(null),R=(0,d.A)(t,v),P=(0,a.useState)("0s"),y=P[0],T=P[1],x=(0,a.useState)(null),b=x[0],O=x[1],A=(0,a.useCallback)(((e,t)=>{O(e),T(t?t/1e3+"s":"0s")}),[O,T]),k=(0,a.useCallback)((e=>{A(null!=n?n:.2,e)}),[n,A]),w=(0,a.useCallback)((e=>{A(null,e)}),[A]),L=function(e,t){var n=(0,a.useRef)(null);null==n.current&&(n.current=new D(t));var s=n.current;return(0,a.useEffect)((()=>{s.configure(t)}),[t,s]),(0,a.useEffect)((()=>()=>{s.reset()}),[s]),(0,a.useDebugValue)(t),s.getEventHandlers()}(0,(0,a.useMemo)((()=>({cancelable:!E,disabled:l,delayLongPress:r,delayPressStart:s,delayPressEnd:i,onLongPress:m,onPress:f,onPressStart(e){var t=null!=e.dispatchConfig?"onResponderGrant"===e.dispatchConfig.registrationName:"keydown"===e.type;k(t?0:150),null!=p&&p(e)},onPressEnd(e){w(250),null!=_&&_(e)}})),[r,s,i,l,m,f,p,_,E,k,w]));return a.createElement(o.A,(0,c.A)({},S,L,{accessibilityDisabled:l,focusable:!l&&!1!==h,pointerEvents:l?"none":void 0,ref:R,style:[N.root,!l&&N.actionable,g,null!=b&&{opacity:b},{transitionDuration:y}]}))}var N=l.A.create({root:{transitionProperty:"opacity",transitionDuration:"0.15s",userSelect:"none"},actionable:{cursor:"pointer",touchAction:"manipulation"}}),k=a.memo(a.forwardRef(A));k.displayName="TouchableOpacity";const w=k;var L=n(8506),I=a.forwardRef(((e,t)=>{var n=e.accessibilityLabel,s=e.color,i=e.disabled,r=e.onPress,o=e.testID,l=e.title;return a.createElement(w,{accessibilityLabel:n,accessibilityRole:"button",disabled:i,focusable:!i,onPress:r,ref:t,style:[J.button,s&&{backgroundColor:s},i&&J.buttonDisabled],testID:o},a.createElement(L.A,{style:[J.text,i&&J.textDisabled]},l))}));I.displayName="Button";var J=l.A.create({button:{backgroundColor:"#2196F3",borderRadius:2},text:{color:"#fff",fontWeight:"500",padding:8,textAlign:"center",textTransform:"uppercase"},buttonDisabled:{backgroundColor:"#dfdfdf"},textDisabled:{color:"#a1a1a1"}});const C=I;var V=n(509);const G={code:"function RunOnJSTsx1(){const{runOnJS,setFinished}=this.__closure;runOnJS(setFinished)(true);}"},M={code:"function RunOnJSTsx2(){const{scale}=this.__closure;return{transform:[{scale:scale.value}]};}"};function F(){const e=(0,V.UAN)(1),[t,n]=a.useState(!1),s=(0,V.mPH)(function(){const t=()=>({transform:[{scale:e.value}]});return t.__closure={scale:e},t.__workletHash=8738913883780,t.__initData=M,t}());return(0,i.jsxs)(o.A,{style:H.container,children:[(0,i.jsx)(V.Ay$.View,{style:[H.box,s]}),(0,i.jsx)(C,{onPress:()=>{e.value=(0,V.eky)(2,{},function(){const e=function(){(0,V.OGr)(n)(!0)};return e.__closure={runOnJS:V.OGr,setFinished:n},e.__workletHash=7767882256352,e.__initData=G,e}())},title:"Click me",disabled:t}),t&&(0,i.jsx)(L.A,{children:"Finished! \ud83c\udf89"})]})}const H=l.A.create({container:{flex:1,alignItems:"center"},box:{height:100,width:100,backgroundColor:"#b58df1",borderRadius:20,marginVertical:64,alignSelf:"center"}}),U="import React from 'react';\nimport { Button, View, StyleSheet, Text } from 'react-native';\nimport Animated, {\n  useSharedValue,\n  withSpring,\n  runOnJS,\n} from 'react-native-reanimated';\nimport { useAnimatedStyle } from 'react-native-reanimated';\n\nexport default function App() {\n  const scale = useSharedValue<number>(1);\n  const [finished, setFinished] = React.useState<boolean>(false);\n\n  const handlePress = () => {\n    scale.value = withSpring(2, {}, () => {\n      // highlight-next-line\n      runOnJS(setFinished)(true);\n    });\n  };\n\n  const animatedStyle = useAnimatedStyle(() => ({\n    transform: [{ scale: scale.value }],\n  }));\n\n  return (\n    <View style={styles.container}>\n      <Animated.View style={[styles.box, animatedStyle]} />\n      <Button onPress={handlePress} title=\"Click me\" disabled={finished} />\n      {finished && <Text>Finished! \ud83c\udf89</Text>}\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    alignItems: 'center',\n  },\n  box: {\n    height: 100,\n    width: 100,\n    backgroundColor: '#b58df1',\n    borderRadius: 20,\n    marginVertical: 64,\n    alignSelf: 'center',\n  },\n});\n",Y={sidebar_position:1},z="runOnJS",B={},X=[{value:"Reference",id:"reference",level:2},{value:"Arguments",id:"arguments",level:3},{value:"fn",id:"fn",level:4},{value:"Returns",id:"returns",level:3},{value:"Example",id:"example",level:2},{value:"Remarks",id:"remarks",level:2},{value:"Platform compatibility",id:"platform-compatibility",level:2}];function K(e){const t={a:"a",admonition:"admonition",code:"code",del:"del",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components},{Details:n,Indent:s,InteractiveExample:a,PlatformCompatibility:o}=t;return n||q("Details",!0),s||q("Indent",!0),a||q("InteractiveExample",!0),o||q("PlatformCompatibility",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"runonjs",children:"runOnJS"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"runOnJS"})," lets you asynchronously run non-",(0,i.jsx)(t.a,{href:"/docs/fundamentals/glossary#to-workletize",children:"workletized"})," functions that couldn't otherwise run on the ",(0,i.jsx)(t.a,{href:"/docs/fundamentals/glossary#ui-thread",children:"UI thread"}),". This applies to most external libraries as they don't have their functions marked with ",(0,i.jsx)(t.code,{children:'"worklet";'})," directive."]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"runOnJS"})," is usually used to update React state either on animation finish or conditionally within a gesture."]}),"\n",(0,i.jsx)(t.h2,{id:"reference",children:"Reference"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-javascript",children:"import { runOnJS } from 'react-native-reanimated';\n\nfunction App() {\n  // While on the UI thread\n  runOnJS(navigation.goBack)();\n}\n"})}),"\n",(0,i.jsxs)(n,{children:[(0,i.jsx)("summary",{children:"Type definitions"}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",children:"function runOnJS<A extends any[], R>(\n  fn: (...args: A) => R\n): (...args: Parameters<typeof fn>) => void;\n"})})]}),"\n",(0,i.jsx)(t.h3,{id:"arguments",children:"Arguments"}),"\n",(0,i.jsx)(t.h4,{id:"fn",children:"fn"}),"\n",(0,i.jsxs)(t.p,{children:["A reference to a function you want to execute on the ",(0,i.jsx)(t.a,{href:"/docs/fundamentals/glossary#javascript-thread",children:"JavaScript thread"})," from the ",(0,i.jsx)(t.a,{href:"/docs/fundamentals/glossary#ui-thread",children:"UI thread"}),". Arguments to your function have to be passed to the function returned from ",(0,i.jsx)(t.code,{children:"runOnJS"})," i.e. ",(0,i.jsx)(t.code,{children:"runOnJS(setValue)(10);"}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"returns",children:"Returns"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"runOnJS"})," returns a function that accepts arguments for the function passed as the first argument. This function can be safely executed on the UI thread."]}),"\n",(0,i.jsx)(t.admonition,{type:"info",children:(0,i.jsxs)(t.p,{children:["Don't forget to call the function returned from ",(0,i.jsx)(t.code,{children:"runOnJS"}),"."]})}),"\n",(0,i.jsx)(t.h2,{id:"example",children:"Example"}),"\n","\n",(0,i.jsx)(a,{src:U,component:F}),"\n",(0,i.jsx)(t.h2,{id:"remarks",children:"Remarks"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Functions passed to ",(0,i.jsx)(t.code,{children:"runOnJS"})," must be defined in the ",(0,i.jsx)(t.a,{href:"/docs/fundamentals/glossary#javascript-thread",children:"JavaScript thread"})," scope, i.e. in the component body or the global scope. The code below won't work because ",(0,i.jsx)(t.code,{children:"myFunction"})," is defined in the ",(0,i.jsx)(t.code,{children:"withTiming"})," callback, which is only executed in the ",(0,i.jsx)(t.a,{href:"/docs/fundamentals/glossary#ui-thread",children:"UI thread"}),":"]}),"\n"]}),"\n",(0,i.jsx)(s,{children:(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-jsx",children:"withTiming(0, {}, () => {\n  // myFunction is defined on the UI thread \ud83d\udea8\n  const myFunction = () => {\n    // ...\n  };\n  runOnJS(myFunction)(); // \ud83d\udca5\n});\n"})})}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["It's a common mistake to execute function inside of runOnJS like this: ",(0,i.jsx)(t.del,{children:(0,i.jsx)(t.code,{children:"runOnJS(setValue(10))()"})}),". Here, the correct usage would be ",(0,i.jsx)(t.code,{children:"runOnJS(setValue)(10)"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:["It's safe to run functions via ",(0,i.jsx)(t.code,{children:"runOnJS"})," on the ",(0,i.jsx)(t.a,{href:"/docs/fundamentals/glossary#javascript-thread",children:"JavaScript thread"}),", as this has no effect."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"platform-compatibility",children:"Platform compatibility"}),"\n",(0,i.jsx)(o,{android:!0,ios:!0,web:!0})]})}function W(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(K,{...e})}):K(e)}function q(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}}}]);